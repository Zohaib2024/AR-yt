<!DOCTYPE html>
<html lang="en">
<head>
    <title>three.js AR - Hit Test</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <link type="text/css" rel="stylesheet" href="main.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
</head>
<body>

    <div id="content">
        <div id="mySidenav" class="sidenav">
            <a href="javascript:void(0)" class="closebtn" onclick="closeNav()">&times;</a>
            <a class="ar-object" id="1" href="#">burger</a>
            <a class="ar-object" id="2" href="#">chicken</a>
            <a class="ar-object" id="3" href="#">pizza</a>
            <a class="ar-object" id="4" href="#">noodle</a>
        </div>
        
        <div id="container" style="position: fixed;"></div>
          
        <span style="font-size:30px;cursor:pointer;position: absolute;" onclick="openNav()">&#9776; open</span>
    
        <button type="button" id="place-button" style="display: none;">PLACE</button>
    </div>

    <script>
        function openNav() {
            document.getElementById("mySidenav").style.width = "250px";
        }
        
        function closeNav() {
            document.getElementById("mySidenav").style.width = "0";
        }
    </script>

    <script type="module">
        import * as THREE from './build/three.module.js';
        import { ARButton } from './jsm/webxr/ARButton.js';
        import { VRButton } from './jsm/webxr/VRButton.js';
        import { OrbitControls } from './jsm/controls/OrbitControls.js';
        import { GLTFLoader } from './jsm/loaders/GLTFLoader.js';
        import { RGBELoader } from './jsm/loaders/RGBELoader.js';
        
        let container, camera, scene, renderer, controls;
        let currentObject, reticle, pmremGenerator, envMap;
        let hitTestSource = null, hitTestSourceRequested = false;
        let isAR = false;

        init();
        animate();

        $(".ar-object").click(function(){
            if (currentObject) {
                scene.remove(currentObject);
            }
            loadModel($(this).attr("id"));
        });

        $("#place-button").click(function(){
            placeObject();
        });

        function placeObject() {
            if (reticle.visible) {
                currentObject.position.setFromMatrixPosition(reticle.matrix);
                currentObject.visible = true;
            }
        }

        function loadModel(modelId) {
            new RGBELoader()
                .setDataType(THREE.UnsignedByteType)
                .setPath('textures/')
                .load('photo_studio_01_1k.hdr', function(texture) {
                    envMap = pmremGenerator.fromEquirectangular(texture).texture;
                    scene.environment = envMap;
                    texture.dispose();
                    pmremGenerator.dispose();
                    render();

                    const loader = new GLTFLoader().setPath('3d/');
                    loader.load(`${modelId}.glb`, function(glb) {
                        currentObject = glb.scene;
                        currentObject.visible = false;
                        scene.add(currentObject);

                        controls.update();
                        render();
                    });
                });
        }

        function init() {
            container = document.createElement('div');
            document.getElementById("container").appendChild(container);

            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.001, 200);
            scene.add(camera);

            const directionalLight = new THREE.DirectionalLight(0xffffff, 1);
            directionalLight.position.set(0, 10, 10).normalize();
            scene.add(directionalLight);

            const ambientLight = new THREE.AmbientLight(0x404040, 2);
            scene.add(ambientLight);

            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.xr.enabled = true;
            container.appendChild(renderer.domElement);

            pmremGenerator = new THREE.PMREMGenerator(renderer);
            pmremGenerator.compileEquirectangularShader();

            controls = new OrbitControls(camera, renderer.domElement);
            controls.target.set(0, 0, -0.2);
            controls.update();

            document.body.appendChild(VRButton.createButton(renderer));
            document.body.appendChild(ARButton.createButton(renderer, { requiredFeatures: ['hit-test'] }));

            reticle = new THREE.Mesh(
                new THREE.RingBufferGeometry(0.15, 0.2, 32).rotateX(-Math.PI / 2),
                new THREE.MeshBasicMaterial({ color: 0x00ff00 })
            );
            reticle.matrixAutoUpdate = false;
            reticle.visible = false;
            scene.add(reticle);

            window.addEventListener('resize', onWindowResize);
            renderer.domElement.addEventListener('click', placeObject);
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        function animate() {
            renderer.setAnimationLoop(render);
        }

        function render(timestamp, frame) {
            if (frame) {
                const session = renderer.xr.getSession();
                if (!hitTestSourceRequested) {
                    session.requestReferenceSpace('viewer').then(referenceSpace => {
                        session.requestHitTestSource({ space: referenceSpace }).then(source => {
                            hitTestSource = source;
                        });
                    });

                    session.addEventListener('end', () => {
                        hitTestSourceRequested = false;
                        hitTestSource = null;
                        isAR = false;
                        reticle.visible = false;
                        $("#place-button").hide();
                    });

                    hitTestSourceRequested = true;
                }

                if (hitTestSource) {
                    const hitTestResults = frame.getHitTestResults(hitTestSource);
                    if (hitTestResults.length) {
                        const hit = hitTestResults[0];
                        reticle.visible = true;
                        reticle.matrix.fromArray(hit.getPose(renderer.xr.getReferenceSpace()).transform.matrix);
                        $("#place-button").show();
                    } else {
                        reticle.visible = false;
                        $("#place-button").hide();
                    }
                }
            }
            renderer.render(scene, camera);
        }
    </script>
</body>
</html>
